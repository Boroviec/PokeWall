<!DOCTYPE html>
<html lang='en'>
<head>
  <meta charset='UTF-8' />
  <meta name='viewport' content='width=device-width, initial-scale=1.0' />
  <title>PokeWall â€“ 151 PokÃ©mon TCG cards</title>
  <style>
    :root {
      --card-w: 120px;
      --card-h: 160px;
      --gap: 16px;
      --fade-dur: 0.9s;
      --ease: cubic-bezier(.25, .46, .45, .94);
      --back-img: url('https://github.com/Boroviec/PokeWall/blob/main/img/cardback.jpg');
    }

    html, body {
      margin: 0;
      background: #f8f8f8;
      font-family: Arial, sans-serif;
      scroll-behavior: smooth;
    }

    h1 {
      margin: 0;
      padding: 24px 0;
      text-align: center;
      font-size: 2.5rem;
      letter-spacing: 1px;
    }

    #wall {
      display: flex;
      flex-wrap: wrap;
      gap: var(--gap);
      padding: var(--gap);
      justify-content: center;
    }

    .family-block {
      background: #000;
      border-radius: 12px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.25);
      padding: 24px;
      display: grid;
      gap: var(--gap);
    }

    .pokemon-card {
      position: relative;
      width: var(--card-w);
      height: var(--card-h);
      overflow: hidden;
      border-radius: 8px;
      will-change: transform;
      transition: transform 0.6s var(--ease);
      cursor: pointer;
    }

    .pokemon-card::before {
      content: '';
      position: absolute;
      inset: 0;
      background-image: var(--back-img);
      background-size: cover;
      background-position: center;
      filter: saturate(0);
      opacity: 1;
      transition: opacity var(--fade-dur) var(--ease);
      pointer-events: none;
    }

    .pokemon-card img {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      object-fit: contain;
      opacity: 0;
      filter: saturate(0);
      transition: opacity var(--fade-dur) var(--ease) 120ms, filter var(--fade-dur) var(--ease);
      pointer-events: none;
    }

    .pokemon-card.custom::before {
      opacity: 0;
    }
    .pokemon-card.custom img {
      opacity: 1;
      filter: saturate(1);
    }

    .pokemon-card:hover {
      transform: translateY(-4px) scale(1.015);
    }
    .pokemon-card:hover::before {
      opacity: 0;
    }
    .pokemon-card:hover img {
      opacity: 1;
    }

    #overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.4s var(--ease);
      z-index: 999;
    }
    #overlay.show {
      opacity: 1;
      pointer-events: auto;
    }

    .overlay-content {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 12px;
    }

    #overlay img {
      width: min(80vw, 380px);
      height: auto;
      border-radius: 12px;
      box-shadow: 0 12px 32px rgba(0,0,0,0.6);
      filter: saturate(0);
      transform: scale(0.6) translateY(0);
      transition: transform 0.45s var(--ease), filter var(--fade-dur) var(--ease);
    }
    #overlay.show img {
      transform: scale(1) translateY(0);
      animation: float 6s ease-in-out infinite;
    }
    #overlay img.custom {
      filter: saturate(1);
    }

    @keyframes float {
      0%, 100% { transform: scale(1) translateY(0); }
      50%      { transform: scale(1) translateY(-8px); }
    }

    #upload-btn, #remove-btn {
      background: linear-gradient(135deg, #ffde00 0%, #fa6900 100%);
      border: none;
      border-radius: 30px;
      padding: 10px 28px;
      font-size: 1rem;
      font-weight: 600;
      color: #fff;
      cursor: pointer;
      box-shadow: 0 4px 12px rgba(0,0,0,0.25);
      transition: transform 0.25s var(--ease), box-shadow 0.25s var(--ease);
    }
    #upload-btn:hover, #remove-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 18px rgba(0,0,0,0.35);
    }

    #toast {
      position: fixed;
      bottom: 24px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.8);
      color: #fff;
      padding: 8px 16px;
      border-radius: 24px;
      font-size: 0.9rem;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.4s var(--ease);
      z-index: 1000;
    }
    #toast.show { opacity: 1; }
  </style>
</head>
<body>
  <h1>PokeWall</h1>
  <div id='wall'>Loadingâ€¦</div>

  <div id='overlay'>
    <div class='overlay-content'>
      <img alt='card enlarged' />
      <button id='upload-btn'>Upload</button>
      <button id='remove-btn'>Remove</button>
    </div>
  </div>

  <input type='file' id='uploader' accept='image/*' style='display:none' />
  <div id='toast'></div>
  
  <script src='https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js'></script>
  <script src="https://cdn.jsdelivr.net/npm/@octokit/rest/dist/octokit.umd.min.js"></script>

  <script>
    
    const SHEET_ID = '1NZfjUgrG4uN1lQOPpnRfA9g6n_XSIzLbVpe6BSx7bsE';
    const GID      = '0';
    const CSV_URL  = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/export?format=csv&gid=${GID}`;
    const RAW_ROOT      = "https://raw.githubusercontent.com/boroviec/PokeWall/main";
    const MANIFEST_URL  = `${RAW_ROOT}/data/cards.json`;

    const parseCSV = (text) => {
      const rows = text.trim().split(/\r?\n/).map(line => {
        const cells = line.split(/,(?=(?:[^\\"]*\\"[^\\"]*\\")*[^\\"]*$)/).map(c => c.replace(/^"|"$/g, '').trim());
        return cells;
      });
      return rows;
    };

    const toast = (msg, dur = 1800) => {
      const t = document.getElementById('toast');
      t.textContent = msg;
      t.classList.add('show');
      clearTimeout(t._tm);
      t._tm = setTimeout(() => t.classList.remove('show'), dur);
    };

    async function buildWall() {
      const wall = document.getElementById('wall');
      try {
        const csvText = await fetch(CSV_URL).then(r => r.text());
        const rows    = parseCSV(csvText);
        const header      = rows[0].map(h => h.trim());
        const colNo       = header.indexOf('No.');
        const colGroup    = header.indexOf('Group');
        const colCardLink = header.indexOf('Link to the Card');
        if (colNo === -1 || colGroup === -1 || colCardLink === -1) throw new Error('Required columns not found');

        const families = {};
        const order    = [];
        rows.slice(1).forEach(r => {
          const id = parseInt(r[colNo], 10);
          if (!id || id > 151) return;
          const group = r[colGroup].trim();
          const url   = r[colCardLink].trim();
          if (!families[group]) { families[group] = []; order.push(group); }
          families[group].push({ id, url });
        });

          // ---- NEW ----  load the manifest once per buildWall()
          const manifest = await fetch(`${MANIFEST_URL}?v=${Date.now()}`).then(r => r.json());
          // turn it into a quick lookup table:  { "25": "https://â€¦/cards/25.webp", â€¦ }
          const customImgs = {};
          manifest.forEach(({ id, src }) => { customImgs[id] = `${RAW_ROOT}/${src}`; });

        wall.textContent = '';
        order.sort((a,b)=>a-b).forEach(group => {
          const slab = document.createElement('div');
          slab.className = 'family-block';
          const cards = families[group];
          const cols  = Math.min(cards.length, 9);
          slab.style.gridTemplateColumns = `repeat(${cols}, var(--card-w))`;

          cards.sort((a,b)=>a.id-b.id).forEach(({ id, url }) => {
            const card = document.createElement('div');
            card.className = 'pokemon-card';
            card.dataset.id = id;
            const img = document.createElement('img');
            img.src = customImgs[id] || url;
            card.appendChild(img);
            if (customImgs[id]) card.classList.add('custom');
            slab.appendChild(card);
          });
          wall.appendChild(slab);
        });

        enableInteractions();
      } catch(err) {
        wall.textContent = 'Failed to load data.';
        console.error(err);
      }
    }

    function enableInteractions() {
      const uploader = document.getElementById('uploader');
      const overlay  = document.getElementById('overlay');
      const overlayImg = overlay.querySelector('img');
      const uploadBtn = document.getElementById('upload-btn');
      const removeBtn = document.getElementById('remove-btn');
      let currentCardEl = null;

      document.querySelectorAll('.pokemon-card').forEach(card => {
        card.addEventListener('click', (e) => {
          currentCardEl = card;
          if (e.altKey) {
            uploader.value = '';
            uploader.click();
            return;
          }
          overlayImg.src = card.querySelector('img').src;
          const hasCustom = card.classList.contains('custom');
          uploadBtn.style.display = hasCustom ? 'none' : 'block';
          removeBtn.style.display = hasCustom ? 'block' : 'none';
          overlayImg.classList.toggle('custom', hasCustom);
          overlay.classList.add('show');
        });
      });

      uploadBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        if (!currentCardEl) return;
        uploader.value = '';
        uploader.click();
      });

      removeBtn.addEventListener('click', (e) => {
  e.stopPropagation();
  if (!currentCardEl) return;

  // purely UI changes now:
  currentCardEl.classList.remove('custom');
  currentCardEl.querySelector('img').src = '';
  buildWall();
  overlay.classList.remove('show');
  toast('Custom image removed.');
});

      /* ----------  OWNER-SIDE GITHUB HELPERS  ---------- */
const pwToken = localStorage.getItem("pw_token");             // put your PAT in LS once
const octo    = pwToken ? new Octokit({ auth: pwToken }) : null;

function fileToBase64(file) {
  return new Promise((res, rej) => {
    const r = new FileReader();
    r.onload = () => res(r.result);
    r.onerror = rej;
    r.readAsDataURL(file);
  });
}

async function uploadCardToRepo(file, pokeId) {
  if (!octo) throw new Error("No owner token in this browser");

  /* 1ï¸âƒ£  create/replace the image --------------------------------------- */
  const dataURL = await fileToBase64(file);               // "data:image/png;base64,AAAâ€¦"
  const ext     = file.type.split("/")[1] || "png";
  const imgPath = `cards/${Date.now()}-${pokeId}.${ext}`; // unique filename

  await octo.request("PUT /repos/{owner}/{repo}/contents/{path}", {
    owner:   "boroviec",
    repo:    "PokeWall",
    path:    imgPath,
    branch:  "main",
    message: `Add custom card ${pokeId}`,
    content: dataURL.split(",")[1]                       // strip "data:*;base64,"
  });

  /* 2ï¸âƒ£  read + patch the manifest -------------------------------------- */
  let manifest = [];
  let sha      = undefined;
  try {
    const { data } = await octo.request(
      "GET /repos/{owner}/{repo}/contents/{path}",
      { owner:"boroviec", repo:"PokeWall", path:"data/cards.json" }
    );
    manifest = JSON.parse(atob(data.content));
    sha      = data.sha;                                  // needed for updates
  } catch (err) {
    if (err.status !== 404) throw err;                    // ignore 404 (first card ever)
  }

  manifest.push({ id: Number(pokeId), src: imgPath });

  await octo.request("PUT /repos/{owner}/{repo}/contents/{path}", {
    owner:   "boroviec",
    repo:    "PokeWall",
    path:    "data/cards.json",
    branch:  "main",
    message: `Update manifest with ${pokeId}`,
    content: btoa(JSON.stringify(manifest, null, 2)),
    sha                                                // absent = *create* file
  });

  return `${RAW_ROOT}/${imgPath}`;                        // public URL for immediate preview
}
/* --------------------------------------------------- */

uploader.addEventListener('change', async e => {
  const file = e.target.files && e.target.files[0];
  if (!file || !currentCardEl) return;

  const pokeId = currentCardEl.dataset.id;
  toast("Uploading to GitHubâ€¦");

  try {
    const publicURL = await uploadCardToRepo(file, pokeId);

    // update UI instantly
    currentCardEl.querySelector('img').src = publicURL;
    currentCardEl.classList.add('custom');
    overlayImg.src = publicURL;
    overlayImg.classList.add('custom');
    uploadBtn.style.display = 'none';
    removeBtn.style.display = 'block';
    toast("Uploaded! Everyone can see it ðŸŽ‰");
    if (typeof confetti === 'function') {
      confetti({ particleCount: 120, spread: 70, scalar: 0.8, origin: { y: 0.55 } });
    }
  } catch (err) {
    console.error(err);
    toast("Upload failed â€“ are you on the owner browser?");
  }
});

      const hideOverlay = () => overlay.classList.remove('show');
      overlay.addEventListener('click', hideOverlay);
      document.addEventListener('keydown', (e) => { if (e.key === 'Escape') hideOverlay(); });
    }

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', buildWall);
    } else {
      buildWall();
    }
  </script>
</body>
</html>
