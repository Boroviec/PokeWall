<!DOCTYPE html>
<html lang='en'>
<head>
<meta charset='UTF-8' />
<meta name='viewport' content='width=device-width, initial-scale=1.0' />
<title>PokeWall – 151 Pokémon Collection</title>
<style>
:root {
--card-w: 120px;
--card-h: 160px;
--gap: 16px;
--fade-dur: 0.9s;
--ease: cubic-bezier(.25, .46, .45, .94);
--back-img: url('https://images.pokemontcg.io/base1/back.png');
}

html, body {
margin: 0;
background: #f8f8f8;
font-family: Arial, sans-serif;
scroll-behavior: smooth;
}

h1 {
margin: 0;
padding: 24px 0;
text-align: center;
font-size: 2.5rem;
letter-spacing: 1px;
}

#wall {
display: flex;
flex-wrap: wrap;
gap: var(--gap);
padding: var(--gap);
justify-content: center;
}

.family-block {
background: 
  linear-gradient(135deg, rgba(255,255,255,0.1) 0%, transparent 50%),
  linear-gradient(45deg, #2a2a2a 0%, #1a1a1a 50%, #0f0f0f 100%);
border-radius: 20px;
box-shadow: 
  0 15px 50px rgba(0,0,0,0.4),
  0 5px 20px rgba(0,0,0,0.3),
  inset 0 2px 0 rgba(255,255,255,0.15),
  inset 0 -2px 0 rgba(0,0,0,0.5);
padding: 32px;
display: grid;
gap: calc(var(--gap) + 4px);
position: relative;
border: 2px solid rgba(255,255,255,0.15);
background-clip: padding-box;
transform: translateY(0) rotateX(0deg);
transition: all 0.5s var(--ease);
perspective: 1000px;
}

.family-block:hover {
transform: translateY(-8px) rotateX(2deg);
box-shadow: 
  0 25px 80px rgba(0,0,0,0.5),
  0 10px 30px rgba(0,0,0,0.4),
  inset 0 2px 0 rgba(255,255,255,0.2),
  inset 0 -2px 0 rgba(0,0,0,0.6);
border: 2px solid rgba(255,255,255,0.25);
}

.family-block::before {
display: none;
}

.family-block::after {
display: none;
}

.family-label {
position: absolute;
top: -12px;
left: 20px;
background: linear-gradient(90deg, #ff6b35, #f7931e);
color: white;
padding: 4px 12px;
border-radius: 12px;
font-size: 12px;
font-weight: bold;
box-shadow: 0 2px 8px rgba(0,0,0,0.2);
}

.pokemon-card {
position: relative;
width: var(--card-w);
height: var(--card-h);
overflow: hidden;
border-radius: 8px;
will-change: transform;
transition: transform 0.6s var(--ease);
cursor: pointer;
}

.pokemon-card::before {
content: '';
position: absolute;
inset: 0;
background-image: var(--back-img);
background-size: cover;
background-position: center;
filter: saturate(0);
opacity: 1;
transition: opacity var(--fade-dur) var(--ease);
pointer-events: none;
}

.pokemon-card img {
position: absolute;
inset: 0;
width: 100%;
height: 100%;
object-fit: contain;
opacity: 0;
filter: saturate(0);
transition: opacity var(--fade-dur) var(--ease) 120ms, filter var(--fade-dur) var(--ease);
pointer-events: none;
}

.pokemon-card.custom::before {
opacity: 0;
}
.pokemon-card.custom img {
opacity: 1;
filter: saturate(1);
}

.pokemon-card:hover {
transform: translateY(-4px) scale(1.015);
}
.pokemon-card:hover::before {
opacity: 0;
}
.pokemon-card:hover img {
opacity: 1;
}

.pokemon-card.custom {
box-shadow: 0 0 20px rgba(255, 107, 53, 0.5);
border: 2px solid rgba(255, 107, 53, 0.3);
}

.custom-badge {
position: absolute;
top: 5px;
right: 5px;
background: linear-gradient(45deg, #ffd700, #ffed4e);
color: #333;
width: 20px;
height: 20px;
border-radius: 50%;
display: flex;
align-items: center;
justify-content: center;
font-size: 12px;
font-weight: bold;
z-index: 2;
box-shadow: 0 2px 4px rgba(0,0,0,0.3);
}

.card-number {
position: absolute;
bottom: 5px;
left: 5px;
background: rgba(0,0,0,0.8);
color: white;
padding: 2px 6px;
border-radius: 4px;
font-size: 11px;
font-weight: bold;
z-index: 2;
}

#overlay {
position: fixed;
inset: 0;
background: rgba(0,0,0,0.7);
display: flex;
align-items: center;
justify-content: center;
opacity: 0;
pointer-events: none;
transition: opacity 0.4s var(--ease);
z-index: 999;
}
#overlay.show {
opacity: 1;
pointer-events: auto;
}

.overlay-content {
display: flex;
flex-direction: column;
align-items: center;
gap: 12px;
}

#overlay img {
width: min(80vw, 380px);
height: auto;
border-radius: 12px;
box-shadow: 0 12px 32px rgba(0,0,0,0.6);
filter: saturate(0);
transform: scale(0.6) translateY(0);
transition: transform 0.45s var(--ease), filter var(--fade-dur) var(--ease);
}
#overlay.show img {
transform: scale(1) translateY(0);
animation: float 6s ease-in-out infinite;
}
#overlay img.custom {
filter: saturate(1);
}

@keyframes float {
0%, 100% { transform: scale(1) translateY(0); }
50%      { transform: scale(1) translateY(-8px); }
}

#upload-btn, #remove-btn {
background: linear-gradient(135deg, #ffde00 0%, #fa6900 100%);
border: none;
border-radius: 30px;
padding: 10px 28px;
font-size: 1rem;
font-weight: 600;
color: #fff;
cursor: pointer;
box-shadow: 0 4px 12px rgba(0,0,0,0.25);
transition: transform 0.25s var(--ease), box-shadow 0.25s var(--ease);
}
#upload-btn:hover, #remove-btn:hover {
transform: translateY(-2px);
box-shadow: 0 8px 18px rgba(0,0,0,0.35);
}

/* Collection Counter - make blue */
.collection-stats {
  text-align: center;
  margin: 10px 0 30px 0;
  font-size: 1.2rem;
  color: #666;
}

.stats-number {
  font-weight: bold;
  color: #3b82f6;
  font-size: 1.4rem;
}

.progress-bar {
  width: 300px;
  height: 8px;
  background: #e0e0e0;
  border-radius: 4px;
  margin: 10px auto;
  overflow: hidden;
}

.progress-fill {
  height: 100%;
  background: linear-gradient(90deg, #3b82f6, #1d4ed8);
  border-radius: 4px;
  transition: width 0.5s ease;
}

/* Enhanced Admin Panel - change to blue */
.admin-toggle {
  position: fixed;
  top: 20px;
  right: 20px;
  width: 50px;
  height: 50px;
  background: linear-gradient(135deg, #3b82f6 50%, #ffffff 50%);
  border: 3px solid #333;
  border-radius: 50%;
  cursor: pointer;
  box-shadow: 0 4px 12px rgba(0,0,0,0.2);
  transition: transform 0.3s var(--ease);
  z-index: 1002;
}

.admin-toggle:hover {
  transform: scale(1.1);
}

.admin-toggle::before {
  content: '';
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  width: 16px;
  height: 16px;
  background: #ffffff;
  border: 3px solid #333;
  border-radius: 50%;
}

.admin-toggle::after {
  content: '';
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  width: 6px;
  height: 6px;
  background: #333;
  border-radius: 50%;
}

#admin-panel {
  position: fixed;
  top: 80px;
  right: 20px;
  background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
  padding: 20px;
  border-radius: 16px;
  box-shadow: 
    0 8px 32px rgba(0,0,0,0.15),
    0 2px 8px rgba(0,0,0,0.1);
  z-index: 1001;
  border: 1px solid rgba(0,0,0,0.1);
  min-width: 200px;
  transform: translateY(-10px) scale(0.9);
  opacity: 0;
  pointer-events: none;
  transition: all 0.3s var(--ease);
}

#admin-panel.show {
  transform: translateY(0) scale(1);
  opacity: 1;
  pointer-events: auto;
}

#admin-panel input {
  width: 100%;
  padding: 10px 12px;
  border: 2px solid #e0e0e0;
  border-radius: 8px;
  font-size: 14px;
  margin-bottom: 12px;
  transition: border-color 0.3s ease;
  box-sizing: border-box;
}

#admin-panel input:focus {
  outline: none;
  border-color: #3b82f6;
  box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
}

#admin-panel button {
  width: 100%;
  padding: 10px;
  background: linear-gradient(135deg, #3b82f6, #1d4ed8);
  color: white;
  border: none;
  border-radius: 8px;
  font-weight: 600;
  cursor: pointer;
  transition: transform 0.2s ease;
  margin-bottom: 10px;
}

#admin-panel button:hover {
  transform: translateY(-1px);
}

#admin-status {
  display: block;
  text-align: center;
  font-size: 12px;
  font-weight: 600;
  margin-top: 8px;
}

/* Pokeball Spinner */
.pokeball-spinner {
  width: 60px;
  height: 60px;
  margin: 40px auto;
  position: relative;
  animation: spin 2s linear infinite;
}

.pokeball-spinner::before {
  content: '';
  position: absolute;
  width: 60px;
  height: 30px;
  background: #ff0000;
  border-radius: 60px 60px 0 0;
  border: 3px solid #333;
  border-bottom: 3px solid #333;
}

.pokeball-spinner::after {
  content: '';
  position: absolute;
  bottom: 0;
  width: 60px;
  height: 30px;
  background: #ffffff;
  border-radius: 0 0 60px 60px;
  border: 3px solid #333;
  border-top: none;
}

.pokeball-center {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  width: 20px;
  height: 20px;
  background: #ffffff;
  border: 4px solid #333;
  border-radius: 50%;
  z-index: 1;
}

.pokeball-center::before {
  content: '';
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  width: 8px;
  height: 8px;
  background: #333;
  border-radius: 50%;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

/* Skeleton Loading Cards */
.skeleton-card {
  position: relative;
  width: var(--card-w);
  height: var(--card-h);
  background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
  background-size: 200% 100%;
  animation: loading 1.5s infinite;
  border-radius: 8px;
  border: 2px solid #e8e8e8;
  position: relative;
}

.skeleton-card::before {
  content: '';
  position: absolute;
  inset: 4px;
  background: linear-gradient(135deg, #f5f5f5 0%, #e5e5e5 100%);
  border-radius: 6px;
  opacity: 0.5;
}

@keyframes loading {
  0% { background-position: 200% 0; }
  100% { background-position: -200% 0; }
}

/* Enhanced Skeleton Loading with Pokemon Blue Theme */
.skeleton-family-block {
  background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
  border-radius: 16px;
  box-shadow: 
    0 8px 32px rgba(0,0,0,0.3),
    inset 0 1px 0 rgba(255,255,255,0.1);
  padding: 28px;
  display: grid;
  gap: var(--gap);
  position: relative;
  border: 1px solid rgba(255,255,255,0.1);
  animation: skeleton-pulse 2s ease-in-out infinite;
}

.skeleton-family-block::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 1px;
  background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
}

/* Remove skeleton family label completely */
.skeleton-family-label {
  display: none;
}

.hidden { display: none !important; }

@keyframes skeleton-pulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.8; }
}
</style>
</head>
<body>
<h1>PokeWall</h1>

<div class="collection-stats">
  <div>
    <span class="stats-number" id="collected-count">0</span> / 
    <span class="stats-number">151</span> Pokémon Collected
  </div>
  <div class="progress-bar">
    <div class="progress-fill" id="progress-fill" style="width: 0%"></div>
  </div>
</div>

<div class="admin-toggle" onclick="toggleAdminPanel()" title="Admin Panel"></div>

<div id="admin-panel">
  <input type="password" id="admin-password" placeholder="Enter admin password">
  <button onclick="toggleAdmin()">Login</button>
  <span id="admin-status"></span>
</div>

<div id='wall'>
  <div style="text-align: center; padding: 40px;">
    <div class="pokeball-spinner">
      <div class="pokeball-center"></div>
    </div>
    <div style="margin-top: 20px; color: #666; font-size: 1.1rem;">
      Loading Pokémon cards...
    </div>
  </div>
</div>

<div id='overlay' onclick="closeOverlay()">
<div class='overlay-content'>
<img id="overlay-img" alt='card enlarged' />
<button id='upload-btn' class="hidden" onclick="triggerUpload()">Upload</button>
<button id='remove-btn' class="hidden" onclick="removePhoto()">Remove</button>
</div>
</div>

<input type='file' id='file-input' accept='image/*' style='display:none' onchange="uploadPhoto()" />

<script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-database-compat.js"></script>
<script src="firebase-config.js"></script>
<script>
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

let isAdmin = false;
let currentCardId = null;
let adminPanelVisible = false;

// Google Sheets configuration
const SHEET_ID = '1NZfjUgrG4uN1lQOPpnRfA9g6n_XSIzLbVpe6BSx7bsE';
const GID = '0';
const CSV_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/export?format=csv&gid=${GID}`;

// CSV parsing helper
const parseCSV = text => text.trim().split(/\r?\n/)
  .map(line => line.split(/,(?=(?:[^\\"]*\\"[^\\"]*\\")*[^\\"]*$)/)
  .map(c => c.replace(/^"|"$/g, '').trim()));

// Enhanced loadCards function with performance optimizations
async function loadCards() {
  const wall = document.getElementById('wall');
  showSkeletonLoading(wall);

  try {
    // Load Google Sheets and Firebase data in parallel
    const [csvText, customImages] = await Promise.all([
      fetch(CSV_URL).then(r => r.text()),
      db.ref('cards').once('value')
    ]);
    
    const rows = parseCSV(csvText);
    const header = rows[0].map(h => h.trim());
    
    const colNo = header.indexOf('No.');
    const colGroup = header.indexOf('Group');
    const colCardLink = header.indexOf('Link to the Card');
    
    if (colNo === -1 || colGroup === -1 || colCardLink === -1) {
      throw new Error('Required columns not found in Google Sheets');
    }

    // Parse Pokemon data from sheets
    const families = {};
    const order = [];
    
    rows.slice(1).forEach(r => {
      const id = parseInt(r[colNo], 10);
      if (!id || id > 151) return;
      const group = r[colGroup].trim();
      const url = r[colCardLink].trim();
      
      if (!families[group]) { 
        families[group] = []; 
        order.push(group); 
      }
      families[group].push({ id, url, group });
    });

    const customData = customImages.val() || {};
    
    // Update stats
    updateCollectionStats(customData);
    wall.innerHTML = '';
    
    // Create family blocks with lazy loading
    order.sort((a,b) => Number(a) - Number(b)).forEach(group => {
      const cards = families[group];
      
      const slab = document.createElement('div');
      slab.className = 'family-block';
      const cols = Math.min(cards.length, 9);
      slab.style.gridTemplateColumns = `repeat(${cols}, var(--card-w))`;

      cards.sort((a,b) => a.id - b.id).forEach(({ id, url }) => {
        const card = document.createElement('div');
        card.className = 'pokemon-card';
        card.dataset.id = id;
        card.onclick = () => openCard(id);
        
        // Add card number
        const cardNumber = document.createElement('div');
        cardNumber.className = 'card-number';
        cardNumber.textContent = `#${id}`;
        card.appendChild(cardNumber);
        
        // Use custom image if available
        if (customData[id]) {
          const img = document.createElement('img');
          // Lazy load images for better performance
          img.loading = 'lazy';
          img.src = customData[id].url;
          card.appendChild(img);
          card.classList.add('custom');
          
        } else if (url) {
          const img = document.createElement('img');
          img.loading = 'lazy';
          img.src = url;
          card.appendChild(img);
        }
        
        slab.appendChild(card);
      });
      
      wall.appendChild(slab);
    });

  } catch (error) {
    console.error('Error loading Pokemon data:', error);
    wall.innerHTML = `
      <div style="text-align: center; padding: 40px; color: #666;">
        <h3>Unable to load Pokemon cards</h3>
        <p>Error: ${error.message}</p>
      </div>
    `;
  }
}

function showSkeletonLoading(wall) {
  wall.innerHTML = '';
  
  // Create realistic skeleton layout that matches actual structure
  const skeletonFamilies = [
    { cards: 3 },  // Family with 3 cards (like Bulbasaur line)
    { cards: 3 },  // Family with 3 cards (like Charmander line)
    { cards: 3 },  // Family with 3 cards (like Squirtle line)
    { cards: 2 },  // Family with 2 cards
    { cards: 1 },  // Single Pokemon
    { cards: 3 },  // Family with 3 cards
    { cards: 2 },  // Family with 2 cards
    { cards: 1 },  // Single Pokemon
    { cards: 3 },  // Family with 3 cards
    { cards: 2 },  // Family with 2 cards
  ];
  
  skeletonFamilies.forEach((family, index) => {
    const slab = document.createElement('div');
    slab.className = 'skeleton-family-block';
    slab.style.gridTemplateColumns = `repeat(${family.cards}, var(--card-w))`;
    
    // Remove skeleton family label - no longer needed
    
    // Add skeleton cards
    for (let i = 0; i < family.cards; i++) {
      const card = document.createElement('div');
      card.className = 'skeleton-card';
      // Add delay for wave effect
      card.style.animationDelay = `${(index * 0.1) + (i * 0.05)}s`;
      slab.appendChild(card);
    }
    
    wall.appendChild(slab);
  });
}

// Update collection stats
function updateCollectionStats(customData) {
  const collectedCount = Object.keys(customData).length;
  const percentage = (collectedCount / 151) * 100;
  
  document.getElementById('collected-count').textContent = collectedCount;
  document.getElementById('progress-fill').style.width = `${percentage}%`;
}

function toggleAdminPanel() {
  const panel = document.getElementById('admin-panel');
  adminPanelVisible = !adminPanelVisible;
  
  if (adminPanelVisible) {
    panel.classList.add('show');
    setTimeout(() => {
      document.getElementById('admin-password').focus();
    }, 300);
  } else {
    panel.classList.remove('show');
  }
}

function toggleAdmin() {
  const password = document.getElementById('admin-password').value;
  const status = document.getElementById('admin-status');
  
  if (password === 'Proste89') {
    isAdmin = true;
    status.textContent = '✅ Admin Access';
    status.style.color = '#28a745';
    setTimeout(() => {
      toggleAdminPanel();
    }, 1500);
  } else {
    isAdmin = false;
    status.textContent = '❌ Access Denied';
    status.style.color = '#dc3545';
  }
}

function openCard(id) {
  currentCardId = id;
  const overlay = document.getElementById('overlay');
  const overlayImg = document.getElementById('overlay-img');
  
  db.ref(`cards/${id}`).once('value').then(snapshot => {
    const data = snapshot.val();
    if (data) {
      overlayImg.src = data.url;
      overlayImg.classList.add('custom');
    } else {
      const cardElement = document.querySelector(`[data-id="${id}"] img`);
      if (cardElement && cardElement.src) {
        overlayImg.src = cardElement.src;
        overlayImg.classList.remove('custom');
      } else {
        overlayImg.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjI2MCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZjBmMGYwIi8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxNiIgZmlsbD0iIzk5OSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPk5vIHBob3RvPC90ZXh0Pjwvc3ZnPg==';
        overlayImg.classList.remove('custom');
      }
    }
  });
  
  document.getElementById('upload-btn').className = isAdmin ? '' : 'hidden';
  document.getElementById('remove-btn').className = isAdmin ? '' : 'hidden';
  overlay.classList.add('show');
}

function closeOverlay() {
  document.getElementById('overlay').classList.remove('show');
}

function triggerUpload() {
  document.getElementById('file-input').click();
}

// Image compression function
function compressImage(file, maxSizeMB = 5) {
  return new Promise((resolve) => {
    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');
    const img = new Image();
    
    img.onload = function() {
      // Calculate new dimensions (max 1000px width/height for smaller files)
      let { width, height } = img;
      const maxDimension = 1000;
      
      if (width > height && width > maxDimension) {
        height = (height * maxDimension) / width;
        width = maxDimension;
      } else if (height > maxDimension) {
        width = (width * maxDimension) / height;
        height = maxDimension;
      }
      
      canvas.width = width;
      canvas.height = height;
      
      // Draw and compress
      ctx.drawImage(img, 0, 0, width, height);
      
      // Start with medium quality for smaller files
      let quality = 0.8;
      let dataUrl = canvas.toDataURL('image/jpeg', quality);
      
      // Reduce quality until under size limit
      while (dataUrl.length > maxSizeMB * 1024 * 1024 && quality > 0.1) {
        quality -= 0.1;
        dataUrl = canvas.toDataURL('image/jpeg', quality);
      }
      
      resolve(dataUrl);
    };
    
    img.src = URL.createObjectURL(file);
  });
}

async function uploadPhoto() {
  const file = document.getElementById('file-input').files[0];
  if (!file || !isAdmin || !currentCardId) return;
  if (!file.type.startsWith('image/')) {
    alert('Please choose an image file.');
    return;
  }

  // Show upload progress
  const uploadBtn = document.getElementById('upload-btn');
  const originalText = uploadBtn.textContent;
  uploadBtn.textContent = 'Compressing...';
  uploadBtn.disabled = true;

  try {
    // Compress image to fit in Realtime Database
    const compressedDataUrl = await compressImage(file);
    
    uploadBtn.textContent = 'Uploading...';
    
    // Store compressed image in Realtime Database
    await db.ref(`cards/${currentCardId}`).set({
      url: compressedDataUrl,
      timestamp: Date.now(),
      filename: file.name
    });
    
    alert('Photo uploaded successfully!');
    closeOverlay();
    loadCards();
    
  } catch (error) {
    console.error('Upload error:', error);
    alert('Upload failed: ' + error.message);
  } finally {
    uploadBtn.textContent = originalText;
    uploadBtn.disabled = false;
  }
}

async function removePhoto() {
  if (!isAdmin || !currentCardId) return;
  
  if (confirm('Remove this photo?')) {
    try {
      await db.ref(`cards/${currentCardId}`).remove();
      alert('Photo removed!');
      closeOverlay();
      loadCards();
    } catch (error) {
      alert('Remove failed: ' + error.message);
    }
  }
}

// Initialize
document.addEventListener('DOMContentLoaded', loadCards);

// Close admin panel when clicking outside
document.addEventListener('click', (e) => {
  const panel = document.getElementById('admin-panel');
  const toggle = document.querySelector('.admin-toggle');
  
  if (adminPanelVisible && !panel.contains(e.target) && !toggle.contains(e.target)) {
    toggleAdminPanel();
  }
});
</script>
</body>
</html>